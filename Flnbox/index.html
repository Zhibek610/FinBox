<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FinBox</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Outfit:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        display: ['Outfit', 'sans-serif'],
                    },
                    colors: {
                        primary: '#10b981', 
                        secondary: '#10b981', 
                        accent: '#10b981', 
                        destructive: '#10b981',
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #f8fafc;
            font-family: 'Inter', sans-serif;
        }
        .page-section {
            display: none;
            animation: fadeIn 0.4s ease-out;
        }
        .page-section.active {
            display: flex;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .glass-effect {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
        }
        
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        
        .input-container {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
            opacity: 0;
        }
        .input-container.visible {
            max-height: 100px;
            opacity: 1;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4 md:p-8 bg-slate-50 text-slate-900">

   
    <div class="w-full max-w-md bg-white rounded-[2rem] shadow-2xl overflow-hidden min-h-[800px] flex flex-col relative border border-slate-100">
        
        
        <div class="absolute top-[-100px] left-[-100px] w-[300px] h-[300px] bg-emerald-500/5 rounded-full blur-[80px] pointer-events-none"></div>
        <div class="absolute bottom-[-100px] right-[-100px] w-[300px] h-[300px] bg-emerald-500/5 rounded-full blur-[80px] pointer-events-none"></div>

        
        <header id="app-header" class="hidden absolute top-0 left-0 right-0 z-20 p-6 flex items-center justify-between bg-white/80 backdrop-blur-sm border-b border-slate-100">
            <div class="flex items-center gap-2">
                <div class="w-8 h-8 bg-emerald-500 rounded-lg flex items-center justify-center shadow-lg shadow-emerald-500/20">
                    <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path></svg>
                </div>
                <span class="text-xl font-bold font-display tracking-tight">FinBox</span>
            </div>
            <button onclick="navigate('dashboard')" class="text-sm font-medium text-slate-500 hover:text-emerald-600 transition-colors">Меню</button>
        </header>

        
        <main class="flex-1 flex flex-col relative z-10 overflow-hidden">

            
            <div id="page-login" class="page-section active flex-col items-center justify-center p-8 h-full flex-1">
                <div class="w-full space-y-8">
                    <div class="text-center space-y-4">
                        <div class="w-16 h-16 bg-emerald-500 text-white rounded-2xl flex items-center justify-center mx-auto shadow-xl shadow-emerald-500/30 mb-6">
                            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path></svg>
                        </div>
                        <h1 class="text-4xl font-bold font-display tracking-tight text-slate-900">FinBox</h1>
                        <p class="text-slate-500 text-lg">Управляйте своими финансами легко</p>
                    </div>

                    <form onsubmit="handleLogin(event)" class="space-y-6 mt-8">
                        <div class="space-y-4">
                            <div class="space-y-2">
                                <label class="text-sm font-medium text-slate-500 ml-1">Ваше Имя</label>
                                <input type="text" id="login-name" placeholder="" class="w-full h-14 px-4 rounded-xl bg-slate-50 border-2 border-transparent focus:bg-white focus:border-emerald-500/20 focus:outline-none transition-all text-lg">
                            </div>
                            <div class="space-y-2">
                                <label class="text-sm font-medium text-slate-500 ml-1">Электронная почта</label>
                                <input type="email" id="login-email" placeholder="" class="w-full h-14 px-4 rounded-xl bg-slate-50 border-2 border-transparent focus:bg-white focus:border-emerald-500/20 focus:outline-none transition-all text-lg">
                            </div>
                        </div>
                        <div id="login-error" class="text-emerald-600 text-sm text-center font-medium hidden">Пожалуйста, заполните все поля</div>
                        <button type="submit" class="w-full h-14 rounded-xl bg-slate-900 text-white text-lg font-bold shadow-lg shadow-slate-900/20 hover:bg-slate-800 hover:scale-[1.02] transition-all mt-2 flex items-center justify-center gap-2">
                            Войти 
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"></path></svg>
                        </button>
                    </form>
                </div>
            </div>

            
            <div id="page-dashboard" class="page-section flex-col p-8 h-full pt-24">
                <div class="flex items-center justify-between mb-8">
                    <div class="flex items-center gap-2 text-emerald-600 font-bold text-sm uppercase tracking-wider bg-emerald-50 px-3 py-1 rounded-full">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                        Личный кабинет
                    </div>
                </div>

                <div class="mb-10 space-y-2">
                    <h1 class="text-3xl font-bold font-display text-slate-900 leading-tight">
                        Привет, <span id="user-name-display" class="text-emerald-600">User</span>!
                    </h1>
                    <p id="user-email-display" class="text-slate-500 text-lg">user@example.com</p>
                </div>

                <div class="grid gap-5 flex-1">
                    
                    <button onclick="navigate('income')" class="w-full h-32 rounded-[1.5rem] border-2 border-transparent bg-white shadow-lg shadow-slate-100 hover:shadow-xl hover:border-emerald-500/20 hover:scale-[1.02] transition-all group relative overflow-hidden flex flex-col items-center justify-center gap-3">
                        <div class="w-12 h-12 rounded-full bg-emerald-100 text-emerald-600 flex items-center justify-center group-hover:scale-110 transition-transform">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path></svg>
                        </div>
                        <span class="font-bold text-lg text-slate-900">Добавить доход</span>
                    </button>

                    <button onclick="navigate('expense')" class="w-full h-32 rounded-[1.5rem] border-2 border-transparent bg-white shadow-lg shadow-slate-100 hover:shadow-xl hover:border-emerald-500/20 hover:scale-[1.02] transition-all group relative overflow-hidden flex flex-col items-center justify-center gap-3">
                        <div class="w-12 h-12 rounded-full bg-emerald-100 text-emerald-600 flex items-center justify-center group-hover:scale-110 transition-transform">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 17h8m0 0V9m0 8l-8-8-4 4-6-6"></path></svg>
                        </div>
                        <span class="font-bold text-lg text-slate-900">Добавить расход</span>
                    </button>

                    
                    <button onclick="navigate('goal')" class="w-full h-32 rounded-[1.5rem] border-2 border-transparent bg-white shadow-lg shadow-slate-100 hover:shadow-xl hover:border-emerald-500/20 hover:scale-[1.02] transition-all group relative overflow-hidden flex flex-col items-center justify-center gap-3">
                        <div class="w-12 h-12 rounded-full bg-emerald-100 text-emerald-600 flex items-center justify-center group-hover:scale-110 transition-transform">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                        </div>
                        <span class="font-bold text-lg text-slate-900">Создать цель</span>
                    </button>
                </div>
            </div>

            
            <div id="page-income" class="page-section flex-col p-8 h-full pt-24">
                <div class="mb-8 text-center">
                    <h2 class="text-3xl font-bold font-display mb-2">Добавление дохода</h2>
                    <p class="text-slate-500">Выберите источники и укажите суммы</p>
                </div>

                <div class="flex-1 overflow-y-auto pb-4 -mx-4 px-4 scrollbar-hide">
                     <div class="grid gap-4" id="income-categories-list">
                        
                     </div>
                </div>

                <div class="space-y-6 mt-4 pt-4 border-t border-slate-100">
                    <div id="income-error" class="text-emerald-600 text-sm text-center font-medium hidden">Укажите хотя бы один доход</div>
                    <button onclick="handleIncomeSubmit()" class="w-full h-14 rounded-xl bg-emerald-600 hover:bg-emerald-700 text-white text-lg font-bold shadow-lg shadow-emerald-500/25 transition-all flex items-center justify-center gap-2">
                        Далее <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"></path></svg>
                    </button>
                </div>
            </div>

            
            <div id="page-expense" class="page-section flex-col p-8 h-full pt-24">
                <div class="mb-6 text-center">
                    <h2 class="text-3xl font-bold font-display mb-2">Добавление расхода</h2>
                    <p class="text-slate-500">На что потратили?</p>
                </div>

                <div class="flex-1 overflow-y-auto pb-4 -mx-4 px-4 scrollbar-hide">
                     <div class="grid gap-4" id="expense-categories-list">
                        
                     </div>
                </div>

                <div class="space-y-6 mt-4 pt-6 border-t border-slate-100">
                    <div id="expense-error" class="text-emerald-600 text-sm text-center font-medium hidden">Укажите хотя бы один расход</div>
                    <button onclick="handleExpenseSubmit()" class="w-full h-14 rounded-xl bg-emerald-600 hover:bg-emerald-700 text-white text-lg font-bold shadow-lg shadow-emerald-500/25 transition-all flex items-center justify-center gap-2">
                        Далее <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"></path></svg>
                    </button>
                </div>
            </div>

            
            <div id="page-goal" class="page-section flex-col p-8 h-full pt-24">
                <div class="mb-8 text-center">
                    <div class="w-20 h-20 bg-emerald-100 rounded-full flex items-center justify-center mx-auto mb-6 text-emerald-600 ring-8 ring-emerald-50">
                        <svg class="w-10 h-10" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path></svg>
                    </div>
                    <h2 class="text-3xl font-bold font-display mb-2">Создание цели</h2>
                    <p class="text-slate-500">На что будем копить?</p>
                </div>

                <div class="space-y-6 flex-1">
                    <div class="space-y-2">
                        <label class="text-sm font-medium text-slate-500 ml-1">Название цели</label>
                        <input type="text" id="goal-name" placeholder="Например: Новый Макбук" class="w-full h-16 px-4 text-lg rounded-2xl bg-slate-100 border-2 border-transparent focus:bg-white focus:border-emerald-500/30 focus:outline-none transition-all">
                    </div>

                    <div class="space-y-2">
                        <label class="text-sm font-medium text-slate-500 ml-1">Стоимость цели</label>
                        <div class="relative">
                            <span class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 font-semibold">₸</span>
                            <input type="number" id="goal-cost" placeholder="0.00" class="w-full h-16 pl-8 text-2xl font-bold rounded-2xl bg-slate-100 border-2 border-transparent focus:bg-white focus:border-emerald-500/30 focus:outline-none transition-all">
                        </div>
                    </div>
                </div>

                <div class="space-y-4 mt-auto pt-8">
                    <div id="goal-error" class="text-emerald-600 text-sm text-center font-medium hidden">Введите название и стоимость</div>
                    <button onclick="handleGoalSubmit()" class="w-full h-14 rounded-xl bg-emerald-600 hover:bg-emerald-700 text-white text-lg font-bold shadow-lg shadow-emerald-500/25 transition-all flex items-center justify-center gap-2">
                        Посмотреть отчёт <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                    </button>
                </div>
            </div>

            
            <div id="page-report" class="page-section flex-col p-6 h-full pt-20 overflow-y-auto scrollbar-hide pb-8">
                <div class="text-center space-y-2 mb-6">
                    <div class="inline-flex items-center justify-center w-12 h-12 rounded-full bg-emerald-100 text-emerald-600 mb-2">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"></path></svg>
                    </div>
                    <h2 class="text-2xl font-bold font-display text-slate-900">Ваш Финансовый Отчёт</h2>
                    <p class="text-slate-500 text-sm">Мы всё посчитали!</p>
                </div>

                <div class="bg-gradient-to-br from-white to-blue-50 border border-blue-100 rounded-2xl shadow-sm p-5 space-y-4 text-sm leading-relaxed text-slate-700 mb-6">
                    <p id="report-text-main"></p>
                    
                    <div id="report-summary-box" class="mt-4 p-4 bg-white/80 backdrop-blur rounded-xl border border-blue-100 shadow-sm text-center">
                        
                    </div>
                </div>

                <div class="bg-white rounded-2xl p-4 border border-slate-100 shadow-sm space-y-4 mb-6">
                    <h3 class="text-sm font-bold text-center uppercase tracking-wider text-slate-400">Правило 50/30/20</h3>
                    <div class="h-[250px] w-full relative">
                        <canvas id="reportChart"></canvas>
                    </div>
                    <p class="text-xs text-center text-slate-400 px-4">
                        Рекомендуемое распределение вашего бюджета.
                    </p>
                </div>

                <!-- NEW: Forecast Chart Section -->
                <div class="bg-white rounded-2xl p-4 border border-slate-100 shadow-sm space-y-4 mb-6">
                    <h3 class="text-sm font-bold text-center uppercase tracking-wider text-slate-400">Прогноз накоплений</h3>
                    <div class="h-[250px] w-full relative">
                        <canvas id="forecastChart"></canvas>
                    </div>
                    <p class="text-xs text-center text-slate-400 px-4">
                        Динамика накоплений при откладывании 20% ежемесячно.
                    </p>
                </div>

                <div class="flex flex-col gap-3">
                    <button onclick="navigate('dashboard')" class="w-full h-14 rounded-xl border-2 border-slate-200 hover:bg-slate-50 font-bold text-base flex items-center justify-center gap-2 text-slate-700">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
                        Вернуться в кабинет
                    </button>
                    <!-- NEW: Edit Button -->
                    <button onclick="navigate('income')" class="w-full h-14 rounded-xl bg-emerald-50 text-emerald-700 font-bold text-base flex items-center justify-center gap-2 hover:bg-emerald-100 transition-colors">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                        Изменить данные
                    </button>
                </div>
            </div>

        </main>
    </div>

    <script>
        
        const STORAGE_KEY = 'finbox_data';
        
        let user = JSON.parse(localStorage.getItem(STORAGE_KEY)) || { name: '', email: '', income: [], expense: [] };

        function saveUser() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(user));
        }

        
        function navigate(pageId) {
            
            const header = document.getElementById('app-header');
            if (pageId === 'login') {
                header.classList.add('hidden');
            } else {
                header.classList.remove('hidden');
            }

            
            document.querySelectorAll('.page-section').forEach(el => {
                el.classList.remove('active');
            });

            
            document.getElementById(`page-${pageId}`).classList.add('active');

            
            if (pageId === 'dashboard') initDashboard();
            if (pageId === 'income') initIncome();
            if (pageId === 'expense') initExpense();
            if (pageId === 'goal') initGoal();
            if (pageId === 'report') initReport();
        }

        
        function handleLogin(e) {
            e.preventDefault();
            const name = document.getElementById('login-name').value.trim();
            const email = document.getElementById('login-email').value.trim();
            
            if (!name || !email) {
                document.getElementById('login-error').classList.remove('hidden');
                return;
            }

            user.name = name;
            user.email = email;
            saveUser();
            navigate('dashboard');
        }

        
        function initDashboard() {
            document.getElementById('user-name-display').textContent = user.name;
            document.getElementById('user-email-display').textContent = user.email;
        }

        
        const INCOME_CATS = ['Стипендия', 'Зарплата', 'Подработка', 'Другие доходы'];
        
        function initIncome() {
            const container = document.getElementById('income-categories-list');
            container.innerHTML = '';
            document.getElementById('income-error').classList.add('hidden');

            // Map existing income for editing
            const existingIncome = {};
            if(user.income) {
                user.income.forEach(inc => existingIncome[inc.type] = inc.amount);
            }

            INCOME_CATS.forEach((cat, index) => {
                const div = document.createElement('div');
               
                const inputId = `income-input-${index}`;
                const amount = existingIncome[cat] || 0;
                const hasValue = amount > 0;
                
                div.innerHTML = `
                    <div class="bg-white rounded-2xl border-2 ${hasValue ? 'border-emerald-500' : 'border-slate-100'} overflow-hidden transition-all hover:border-emerald-200">
                        <div class="p-4 flex items-center justify-between cursor-pointer" onclick="toggleInput('${inputId}', this)">
                            <span class="font-semibold text-slate-700">${cat}</span>
                            <div class="w-6 h-6 rounded-full ${hasValue ? 'bg-emerald-500 text-white shadow-md shadow-emerald-500/30' : 'bg-slate-100 text-slate-400'} flex items-center justify-center check-icon">
                                ${hasValue 
                                    ? '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>'
                                    : '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>'
                                }
                            </div>
                        </div>
                        <div id="${inputId}" class="input-container bg-slate-50 border-t border-slate-100 px-4 ${hasValue ? 'visible' : ''}">
                             <div class="py-4">
                                <label class="text-xs font-bold text-slate-400 uppercase mb-1 block">Сумма (₸)</label>
                                <input type="number" value="${hasValue ? amount : ''}" data-cat="${cat}" placeholder="0" class="income-value-input w-full h-12 px-4 rounded-xl bg-white border border-slate-200 focus:border-emerald-500 focus:outline-none text-lg font-bold text-slate-900">
                             </div>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function toggleInput(id, headerEl) {
            const el = document.getElementById(id);
            const isVisible = el.classList.contains('visible');
            const icon = headerEl.querySelector('.check-icon');
            
            if (isVisible) {
                el.classList.remove('visible');
                headerEl.parentElement.classList.remove('border-emerald-500');
                icon.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>';
                icon.className = 'w-6 h-6 rounded-full bg-slate-100 flex items-center justify-center text-slate-400 check-icon';
                
                el.querySelector('input').value = '';
            } else {
                el.classList.add('visible');
                headerEl.parentElement.classList.add('border-emerald-500');
                icon.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>';
                icon.className = 'w-6 h-6 rounded-full bg-emerald-500 flex items-center justify-center text-white check-icon shadow-md shadow-emerald-500/30';
                
                setTimeout(() => el.querySelector('input').focus(), 300);
            }
        }

        function handleIncomeSubmit() {
            const inputs = document.querySelectorAll('.income-value-input');
            const newIncomes = [];
            
            inputs.forEach(input => {
                const val = parseFloat(input.value);
                if (val > 0) {
                    newIncomes.push({ type: input.dataset.cat, amount: val });
                }
            });

            if (newIncomes.length === 0) {
                document.getElementById('income-error').classList.remove('hidden');
                return;
            }

            user.income = newIncomes;
            saveUser();
            navigate('expense');
        }

        
        const EXPENSE_CATS = ['Еда', 'Транспорт', 'Учёба', 'Развлечения', 'Одежда', 'Аренда жилья', 'Здоровье'];

        function initExpense() {
            const container = document.getElementById('expense-categories-list');
            container.innerHTML = '';
            document.getElementById('expense-error').classList.add('hidden');

            const existingExpense = {};
            if(user.expense) {
                user.expense.forEach(exp => existingExpense[exp.category] = exp.amount);
            }

            EXPENSE_CATS.forEach((cat, index) => {
                const div = document.createElement('div');
                const inputId = `expense-input-${index}`;
                const amount = existingExpense[cat] || 0;
                const hasValue = amount > 0;
                
                div.innerHTML = `
                    <div class="bg-white rounded-2xl border-2 ${hasValue ? 'border-emerald-500' : 'border-slate-100'} overflow-hidden transition-all hover:border-emerald-200">
                        <div class="p-4 flex items-center justify-between cursor-pointer" onclick="toggleExpenseInput('${inputId}', this)">
                            <span class="font-semibold text-slate-700">${cat}</span>
                            <div class="w-6 h-6 rounded-full ${hasValue ? 'bg-emerald-500 text-white shadow-md shadow-emerald-500/30' : 'bg-slate-100 text-slate-400'} flex items-center justify-center check-icon">
                                ${hasValue 
                                    ? '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>'
                                    : '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>'
                                }
                            </div>
                        </div>
                        <div id="${inputId}" class="input-container bg-slate-50 border-t border-slate-100 px-4 ${hasValue ? 'visible' : ''}">
                             <div class="py-4">
                                <label class="text-xs font-bold text-slate-400 uppercase mb-1 block">Сумма (₸)</label>
                                <input type="number" value="${hasValue ? amount : ''}" data-cat="${cat}" placeholder="0" class="expense-value-input w-full h-12 px-4 rounded-xl bg-white border border-slate-200 focus:border-emerald-500 focus:outline-none text-lg font-bold text-slate-900">
                             </div>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function toggleExpenseInput(id, headerEl) {
            const el = document.getElementById(id);
            const isVisible = el.classList.contains('visible');
            const icon = headerEl.querySelector('.check-icon');
            
            if (isVisible) {
                el.classList.remove('visible');
                headerEl.parentElement.classList.remove('border-emerald-500');
                icon.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>';
                icon.className = 'w-6 h-6 rounded-full bg-slate-100 flex items-center justify-center text-slate-400 check-icon';
                el.querySelector('input').value = '';
            } else {
                el.classList.add('visible');
                headerEl.parentElement.classList.add('border-emerald-500');
                icon.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>';
                icon.className = 'w-6 h-6 rounded-full bg-emerald-500 flex items-center justify-center text-white check-icon shadow-md shadow-emerald-500/30';
                setTimeout(() => el.querySelector('input').focus(), 300);
            }
        }

        function handleExpenseSubmit() {
            const inputs = document.querySelectorAll('.expense-value-input');
            const newExpenses = [];
            
            inputs.forEach(input => {
                const val = parseFloat(input.value);
                if (val > 0) {
                    newExpenses.push({ category: input.dataset.cat, amount: val });
                }
            });

            if (newExpenses.length === 0) {
                document.getElementById('expense-error').classList.remove('hidden');
                return;
            }

            user.expense = newExpenses;
            saveUser();
            navigate('goal');
        }

       
        function initGoal() {
            const goalName = user.goal ? user.goal.name : '';
            const goalCost = user.goal ? user.goal.cost : '';
            
            document.getElementById('goal-name').value = goalName;
            document.getElementById('goal-cost').value = goalCost;
            document.getElementById('goal-error').classList.add('hidden');
        }

        function handleGoalSubmit() {
            const name = document.getElementById('goal-name').value.trim();
            const cost = parseFloat(document.getElementById('goal-cost').value);
            
            if (!name || !cost) {
                document.getElementById('goal-error').classList.remove('hidden');
                return;
            }
            user.goal = { name, cost };
            saveUser();
            navigate('report');
        }

        
        let chartInstance = null;
        let forecastInstance = null;

        function initReport() {
            
            if (!user.income || user.income.length === 0 || !user.expense || user.expense.length === 0 || !user.goal) {
                alert('Пожалуйста, заполните все данные!');
                navigate('dashboard');
                return;
            }

            
            const totalIncome = user.income.reduce((acc, curr) => acc + curr.amount, 0);
            const totalExpense = user.expense.reduce((acc, curr) => acc + curr.amount, 0);
            const goalCost = user.goal.cost;
            
           
            const recommendedSaving = Math.floor(totalIncome * 0.2); 
            const months = Math.ceil(goalCost / recommendedSaving);
            const actualRemainder = totalIncome - totalExpense;

           
            const textMain = document.getElementById('report-text-main');
            
            
            const incomeSources = user.income.map(i => i.type).join(', ');
            const expenseSources = user.expense.map(e => e.category).join(', ');

            textMain.innerHTML = `
                Мы внимательно проанализировали ваши данные, <span class="font-bold text-slate-900">${user.name}</span>. Это здорово, что вы ведете учет! 
                Ваш текущий доход составляет <span class="font-bold text-emerald-600">${totalIncome.toLocaleString()} ₸</span> 
                (источники: <span class="font-medium">${incomeSources}</span>). 
                <br><br>
                Что касается трат, то они составляют <span class="font-bold text-emerald-600">${totalExpense.toLocaleString()} ₸</span> 
                (категории: <span class="font-medium">${expenseSources}</span>). 
                Ваша мечта - <span class="font-bold text-emerald-600">${user.goal.name}</span> стоимостью <span class="font-bold text-slate-900">${goalCost.toLocaleString()} ₸</span>. 
                Это амбициозная, но вполне достижимая цель!
            `;

            const summaryBox = document.getElementById('report-summary-box');
            
            let adviceHtml = '';
            if (actualRemainder < recommendedSaving) {
                adviceHtml = `<div class="mt-4 text-xs text-emerald-600 bg-emerald-50 p-3 rounded-xl border border-emerald-100">
                    <strong>Обратите внимание:</strong> Ваш реальный остаток (${actualRemainder.toLocaleString()} ₸) сейчас меньше рекомендуемой суммы. 
                    Постарайтесь оптимизировать расходы, чтобы уверенно идти к цели.
                </div>`;
            }

            summaryBox.innerHTML = `
                <p class="font-medium text-slate-600 mb-1">Рекомендуем откладывать (20% от дохода):</p>
                <p class="text-3xl font-bold text-emerald-600 tracking-tight mb-3">${recommendedSaving.toLocaleString()} ₸</p>
                
                <div class="pt-3 border-t border-slate-100">
                    <p class="text-sm text-slate-600 leading-relaxed">
                        Согласно правилу 50/30/20, это оптимальная сумма для сбережений. 
                        Вы накопите на <span class="font-semibold text-emerald-600">"${user.goal.name}"</span> 
                        за <span class="font-bold text-emerald-600 text-lg">${months} месяцев</span>, 
                        если будете стабильно откладывать эти 20% от своего дохода.
                    </p>
                </div>
                ${adviceHtml}
            `;

         
            const ctx = document.getElementById('reportChart').getContext('2d');
            if (chartInstance) chartInstance.destroy();

            chartInstance = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['Обязательные (50%)', 'Желания (30%)', 'Накопления (20%)'],
                    datasets: [{
                        data: [totalIncome * 0.5, totalIncome * 0.3, totalIncome * 0.2],
                     
                        backgroundColor: ['#fca5a5', '#fdba74', '#6ee7b7'], 
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { usePointStyle: true, padding: 20 } }
                    }
                }
            });

            // --- NEW: Forecast Line Chart ---
            const ctxForecast = document.getElementById('forecastChart').getContext('2d');
            if (forecastInstance) forecastInstance.destroy();

            const projectionMonths = months > 0 ? Math.min(months + 2, 24) : 12; // Limit to 24 months
            const labels = [];
            const dataSaved = [];
            const dataGoal = [];

            for (let i = 0; i <= projectionMonths; i++) {
                labels.push(`Мес ${i}`);
                dataSaved.push(i * recommendedSaving);
                dataGoal.push(goalCost);
            }

            forecastInstance = new Chart(ctxForecast, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Накоплено',
                            data: dataSaved,
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.3
                        },
                        {
                            label: 'Цель',
                            data: dataGoal,
                            borderColor: '#94a3b8',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            pointRadius: 0,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { usePointStyle: true } },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.parsed.y.toLocaleString() + ' ₸';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: '#f1f5f9' },
                            ticks: {
                                callback: function(value) {
                                    return value / 1000 + 'k';
                                }
                            }
                        },
                        x: {
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        if (user.name) {
            navigate('dashboard');
        } else {
            navigate('login');
        }

    </script>
</body>
</html>
